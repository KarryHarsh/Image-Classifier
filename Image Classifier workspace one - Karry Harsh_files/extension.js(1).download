function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Panel=function(){function e(t){_classCallCheck(this,e),this.Jupyter=t,this.menubarDropdowns={file:"#file_menu",edit:"#edit_menu",view:"#view_menu",insert:"#insert_menu",cell:"#cell_menu",kernel:"#kernel_menu",widgets:"#widget-submenu",help:"#help_menu"};this.toolbarActions={"save-notebook":'[data-jupyter-action="jupyter-notebook:save-notebook"]',"insert-cell-below":'[data-jupyter-action="jupyter-notebook:insert-cell-below"]',"cut-cell":'[data-jupyter-action="jupyter-notebook:cut-cell"]',"copy-cell":'[data-jupyter-action="jupyter-notebook:copy-cell"]',"paste-cell-below":'[data-jupyter-action="jupyter-notebook:paste-cell-below"]',"move-cell-up":'[data-jupyter-action="jupyter-notebook:move-cell-up"]',"move-cell-down":'[data-jupyter-action="jupyter-notebook:move-cell-down"]',"run-cell-and-select-next":'[data-jupyter-action="jupyter-notebook:run-cell-and-select-next"]',"interrupt-kernel":'[data-jupyter-action="jupyter-notebook:interrupt-kernel"]',"confirm-restart-kernel":'[data-jupyter-action="jupyter-notebook:confirm-restart-kernel"]',"confirm-restart-kernel-and-run-all-cells":'[data-jupyter-action="jupyter-notebook:confirm-restart-kernel-and-run-all-cells"]',"cell-type":"#cell_type","show-command-palette":'[data-jupyter-action="jupyter-notebook:show-command-palette"]'}}return _createClass(e,[{key:"setDisplay",value:function(e,t){document.querySelector(e).style.display=t}},{key:"addClass",value:function(e,t){document.querySelector(e).classList.add(t)}},{key:"removeClass",value:function(e,t){document.querySelector(e).classList.remove(t)}},{key:"hideWidgetMenu",value:function(){var e=this,t=document.querySelector("#menus ul.navbar-nav"),n=new MutationObserver(function(t){t.forEach(function(t){var a=t.target.querySelector(e.menubarDropdowns.widgets);a&&(a.parentElement.style.display="none",n.disconnect())})}),a={attributes:!0,childList:!0,characterData:!0};n.observe(t,a)}},{key:"showAll",value:function(){this.addClass("#header-container","show-panel"),this.addClass("#maintoolbar","show-panel"),this.addClass("#menubar-container ul.navbar-nav","show-panel")}},{key:"setup",value:function(e){var t=this;if(e)return void this.showAll();var n=this.Jupyter.notebook.metadata,a=n.udacity,o=a.header,r=void 0===o?{}:o,i=a.toolbar,s=void 0===i?{}:i,u=a.menubar,l=void 0===u?{}:u,c=document.querySelector("#menubar");if(r.hidden||this.addClass("#header-container","show-panel"),!l.hidden&&(this.addClass("#menubar-container ul.navbar-nav","show-panel"),l.hidden_menus)){c.querySelectorAll("ul.navbar-nav > li").forEach(function(e){l.hidden_menus.find(function(n){var a=t.menubarDropdowns[n];return null!=e.querySelector(a)})&&(e.style.display="none")}),l.hidden_menus.includes("widgets")&&this.hideWidgetMenu()}if(s.hidden||(s.hidden_actions&&s.hidden_actions.forEach(function(e){var n=t.toolbarActions[e];n&&t.setDisplay(n,"none")}),this.addClass("#maintoolbar","show-panel")),(s.hidden||l.hidden)&&r.hidden&&c.classList.add("only-panel"),l.hidden&&!s.hidden){var d=document.querySelector("#maintoolbar-container");document.querySelector("#menus .navbar-collapse").before(d),c.classList.add("only-panel"),this.addClass("#maintoolbar-container.toolbar","with-statusbar"),this.removeClass("#maintoolbar","show-panel")}}}]),e}();define("panel.js",function(){});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),PYNG_INTERVAL=12e4,IDLE_TIMEOUT=18e5,RETRY_ATTEMPTS=6,RETRY_INTERVAL=15e3,AUTOSAVE_INTERVAL=15e3,Pyng=function(){function e(t,n){_classCallCheck(this,e),this.Jupyter=t,this.star=n,this.activity=new ActivityTracker({timeout:IDLE_TIMEOUT}),this.activity.start()}return _createClass(e,[{key:"start",value:function(){var e=this;this.mainLoop().catch(function(t){console.log(t),e.stop()}),this.Jupyter.notebook.set_autosave_interval(AUTOSAVE_INTERVAL)}},{key:"mainLoop",value:function(){var e=this;return console.log("Beginning pyng main loop"),new Promise(function(t,n){var a=function(){if(e.activity.isIdle)return console.log("Notebook is idle"),e.stop(),t();retry(function(){return e.star.keepAlive()},RETRY_ATTEMPTS,RETRY_INTERVAL).catch(n)};e.interval=setInterval(function(){return a()},PYNG_INTERVAL)})}},{key:"stop",value:function(){console.log("Stopping notebook pyng"),this.interval&&clearInterval(this.interval),this.activity&&this.activity.stop()}}]),e}(),ActivityTracker=function(){function e(t){var n=this,a=t.timeout,o=t.element,r=void 0===o?document:o,i=t.events,s=void 0===i?["click","keydown","mousemove"]:i;_classCallCheck(this,e),this.lastActivity=Date.now(),this.timeout=a,this.events=s,this.element=r,this.updater=debounce(function(){return n.update()},500)}return _createClass(e,[{key:"update",value:function(){this.lastActivity=Date.now()}},{key:"start",value:function(){var e=this;return this.events.map(function(t){return e.element.addEventListener(t,e.updater)})}},{key:"stop",value:function(){var e=this;return this.events.map(function(t){return e.element.removeEventListener(t,e.updater)})}},{key:"isIdle",get:function(){return Date.now()-this.lastActivity>this.timeout}}]),e}(),sleep=function(e){return new Promise(function(t){return setTimeout(t,e)})},retry=function(e,t,n){return new Promise(function(a,o){!function e(t,n,a,o,r){t().then(o).catch(function(i){return n>1?sleep(a).then(function(){return e(t,n-1,a,o,r)}).catch(r):r(i)})}(e,t,n,a,o)})},debounce=function(e,t,n){var a=void 0;return function(){var o=this,r=arguments,i=function(){a=null,n||e.apply(o,r)},s=n&&!a;clearTimeout(a),a=setTimeout(i,t),s&&e.apply(o,r)}};define("pyng.js",function(){});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Star=function(){function e(t){_classCallCheck(this,e),this.Jupyter=t,this.token=null}return _createClass(e,[{key:"getStarUser",value:function(){var e=this;return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("POST","https://nebula.udacity.com/api/v1/remote/me"),a.setRequestHeader("Authorization","Star "+e.token),a.onload=function(){this.status>=200&&this.status<300?t(JSON.parse(a.response)):n({status:this.status,statusText:a.statusText})},a.onerror=function(){n({status:this.status,statusText:a.statusText})},a.send()})}},{key:"getToken",value:function(){var e=this,t=function(e){return{iopub:{output:function(t){return t.content.text?e(t.content.text):null}}}};return new Promise(function(n,a){e.Jupyter.notebook.kernel.execute('!curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/keep_alive_token" -H "Metadata-Flavor: Google" -s --fail',t(function(t){e.token=t,n(t)}))})}},{key:"keepAlive",value:function(){var e=this;return new Promise(function(t,n){var a=new XMLHttpRequest;a.open("POST","https://nebula.udacity.com/api/v1/remote/keep-alive"),a.setRequestHeader("Authorization","Star "+e.token),a.onload=function(){this.status>=200&&this.status<300?t(a.response):n({status:this.status,statusText:a.statusText})},a.onerror=function(){n({status:this.status,statusText:a.statusText})},a.send()})}}]),e}();define("star.js",function(){}),define("nbextensions/jupyng-dist/extension",["base/js/namespace","panel.js","pyng.js","star.js"],function(e){return{load_ipython_extension:function(){var t=e.notebook.metadata,n=new Star(e),a=new Panel(e);t&&t.udacity||a.showAll(),e.notebook.events.one("kernel_ready.Kernel",function(){n.getToken(e).then(function(){return new Pyng(e,n).start(),n.getStarUser()}).then(function(e){var n=e&&e.coco;t&&t.udacity&&a.setup(n)}).catch(function(e){console.log(e),a.showAll()})})}}});